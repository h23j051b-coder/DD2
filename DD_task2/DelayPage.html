{% extends "global/Page.html" %}
{% load otree %}

{% block title %}
    選択課題（{{ delay }}）
{% endblock %}

{% block content %}

<p><b>以下はあなたが1日目に作成したエピソードです。このエピソードを読み，もう一度情景を思い浮かべてから下記の問いに臨んでください。</b></p>

<p><b>● 選択した目標</b><br>
{% if group == "関連" %}
    {{ delay }} に {{ eft_goal }} を達成して <b>{{ delayed_reward_str }}円</b>を獲得する
{% else %}
    あなたは {{ delay }} に <b>{{ eft_goal }}</b> という目標を達成できる
{% endif %}
</p>

<p><b>● 5W1H での記述</b><br>
{{ eft_5w1h }}
</p>

<p><b>● 感情の記述</b><br>
{{ eft_emotion }}
</p>

<hr>

<p>
以下のうち、あなたがより望ましいと思う方をそれぞれ選んでください。
問いによって「今」や「明日」といった報酬獲得時点と「100円」といった報酬量の組み合わせが変化するため，注意して回答してください。
</p>

<style>
/* 元のスタイルを維持 */
.option-card {
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 16px;
    background: #fdfdfd;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
}
.option-left, .option-right {
    display: flex;
    align-items: center;
    flex: 1 1 auto;
    min-width: 120px;
}
.option-or {
    padding: 0 12px;
    font-weight: bold;
    white-space: nowrap;
    text-align: center;
}
.option-card label {
    display: block;
    width: 100%;
    cursor: pointer;
    margin-bottom: 8px;
}
.option-card input[type="radio"] {
    margin-right: 8px;
}
.option-card:not(:last-child)::after {
    content: "";
    display: block;
    height: 1px;
    background-color: #ccc;
    margin-top: 12px;
}
button {
    width: 100%;
    margin-top: 1rem;
    padding: 0.7rem;
    font-size: 1rem;
}
@media (min-width: 768px) {
    .option-card {
        padding: 12px 16px;
    }
    .option-card:not(:last-child)::after {
        display: none;
    }
}
</style>

<!-- method="post" と CSRF を入れる -->
<form id="choiceForm" method="post">
    {% csrf_token %}
    <input type="hidden" name="choice_data" id="choice_data">

    <!-- amount_pairs は (amount, formatted_str) のリスト -->
    {% for amount, amount_str in amount_pairs %}
    <div class="option-card">
        <label class="option-left">
            <input type="radio" name="choice_{{ forloop.counter }}" value="immediate">
            今 {{ amount_str }}円もらう
        </label>

        <span class="option-or">または</span>

        <label class="option-right">
            <input type="radio" name="choice_{{ forloop.counter }}" value="delayed">
            {{ delay }} に {{ delayed_reward_str }}円もらう
        </label>
    </div>
    {% endfor %}

    <button type="button" id="submitBtn" class="btn btn-primary">回答を確定して次へ</button>
</form>

<script>
// デバッグ用（必要なら有効に）
// console.log("amounts raw:", {{ amounts|json }});

document.getElementById('submitBtn').addEventListener('click', function() {
    // JSON経由で安全に受け取る（escapeを気にするなら |escapejs を検討）
    const amounts = JSON.parse('{{ amounts|json }}');
    const choices = [];
    let missing = false;

    for (let i = 1; i <= amounts.length; i++) {
        const selector = `input[name="choice_${i}"]:checked`;
        const el = document.querySelector(selector);
        if (!el) {
            missing = true;
            break;
        }
        choices.push(el.value);
    }

    if (missing) {
        // ユーザー向けメッセージ（日本語）
        alert('すべての選択肢を選んでから次へ進んでください。');
        return;
    }

    // hidden に JSON を入れて送信
    document.getElementById('choice_data').value = JSON.stringify({ amounts, choices });

    // サブミット
    document.getElementById('choiceForm').submit();
});
</script>

{% endblock %}
